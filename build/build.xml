<?xml version="1.0"?>
<project name="soft" default="all">

    <property file="build.properties"/>
    
    <target name="initialize.aria2">
        <mkdir dir="${out.dir}/downloads"/>
        <get src="https://github.com/aria2/aria2/releases/download/release-1.34.0/aria2-1.34.0-win-64bit-build1.zip"
             dest="${downloads.dir}"
             verbose="true"
             usetimestamp="true"/>
    </target>
    
    <target name="initialize" depends="initialize.aria2"/>
    
    <target name="generators.build.cpp">
        <exec executable="cmd" dir="${generators.dir}/soft.generator.cpp" failonerror="true">
            <arg value="/C"/>
            <arg value="mvn.cmd"/>
            <arg value="-Dproject.target=../${out.dir}/soft.generator.cpp"/>
            <arg line="clean verify" />
        </exec>
    </target>
    
    <target name="generators.clean.cpp">
        <exec executable="cmd" dir="${generators.dir}/soft.generator.cpp" failonerror="true">
            <arg value="/C"/>
            <arg value="mvn.cmd"/>
            <arg value="-Dproject.target=../${out.dir}/soft.generator.cpp"/>
            <arg line="clean" />
        </exec>
    </target>
    
    <target name="generators.install.cpp">
        <unzip src="${out.dir}/soft.generator.cpp/soft.generator.cpp-1.0.0.zip" dest="${bin.dir}/soft.generator.cpp"/>
    </target>
    
    <target name="generators.dist.cpp">
        <copy file="${out.dir}/soft.generator.cpp/soft.generator.cpp-1.0.0.zip" todir="${dist.dir}"/>
    </target>
    
    <target name="generators.build" depends="generators.build.cpp"/>
    <target name="generators.clean" depends="generators.clean.cpp"/>
    <target name="generators.install" depends="generators.install.cpp"/>
    <target name="generators.dist" depends="generators.dist.cpp"/>
    
    <macrodef name="generator.cpp">
        <attribute name="input"/>
        <attribute name="output"/>
        <sequential>
            <java jar="${bin.dir}/soft.generator.cpp/soft.generator.cpp-1.0.0.jar"
                  fork="true"
                  failonerror="true"
                  maxmemory="128m">
                  <arg value="-m"/>
                  <arg value="@{input}"/>
                  <arg value="-o"/>
                  <arg value="@{output}"/>
            </java>
        </sequential>
    </macrodef>
    
    <target name="sources.generate.ecore">
        <generator.cpp input="${models.dir}/ecore.ecore" output="${root.dir}"/>
    </target>
    
    <target name="sources.clean.ecore">
        <exec executable="git" dir="${libraries.dir}/ecore" failonerror="true">
            <arg line="clean -xfd" />
        </exec>
        <exec executable="git" dir="${tests.dir}/ecore.tests" failonerror="true">
            <arg line="clean -xfd" />
        </exec>
    </target>
    
    <target name = "sources.generate" depends="sources.generate.ecore"/>
    <target name = "sources.clean" depends="sources.clean.ecore"/> 
    
    <target name="build.generate">
        <exec taskname="cmake" executable="cmake.exe" dir="${build.dir}/cmake" failonerror="true">
            <arg value="-G"/>
            <arg value="Visual Studio 14 2015 Win64"/>
            <arg value="-B../vs2015"/>
            <arg value="-H."/>
        </exec>
    </target>
    
    <target name="build.clean">
        <exec executable="git" dir="${build.dir}" failonerror="true">
            <arg line="clean -xfd" />
        </exec>
    </target>
    
    <target name="generators" depends="generators.build,generators.dist,generators.install"/>
    
    <target name="generates" depends="sources.generate,build.generate"/>
    
    <target name="clean" depends="generators.clean,sources.clean,build.clean"/>
    
    <target name="all" depends="generators,generates"/>
    
</project>