<?xml version="1.0"?>
<project name="soft" default="all">

    <property name="root.dir" value=".."/>
    <property name="bin.dir" value="bin"/>
    <property name="build.dir" value="build"/>
    <property name="out.dir" value="out"/>
    <property name="dist.dir" value="dist"/>
    <property name="libraries.dir" value="libraries"/>
    <property name="generators.dir" value="generators"/>
    <property name="models.dir" value="models"/>
    <property name="tests.dir" value="tests"/>
    
    <target name="generators.build.cpp">
        <exec executable="cmd" dir="${root.dir}/${generators.dir}/soft.generator.cpp" failonerror="true">
            <arg value="/C"/>
            <arg value="mvn.cmd"/>
            <arg value="-Dproject.target=../../${out.dir}/soft.generator.cpp"/>
            <arg line="clean verify" />
        </exec>
    </target>
    
    <target name="generators.clean.cpp">
        <exec executable="cmd" dir="${root.dir}/${generators.dir}/soft.generator.cpp" failonerror="true">
            <arg value="/C"/>
            <arg value="mvn.cmd"/>
            <arg value="-Dproject.target=../../${out.dir}/soft.generator.cpp"/>
            <arg line="clean" />
        </exec>
    </target>
    
    <target name="generators.install.cpp">
        <unzip src="${root.dir}/${out.dir}/soft.generator.cpp/soft.generator.cpp-1.0.0.zip" dest="${root.dir}/${bin.dir}/soft.generator.cpp"/>
    </target>
    
    <target name="generators.dist.cpp">
        <copy file="${root.dir}/${out.dir}/soft.generator.cpp/soft.generator.cpp-1.0.0.zip" todir="${root.dir}/${dist.dir}"/>
    </target>
    
    <target name="generators.build" depends="generators.build.cpp"/>
    <target name="generators.clean" depends="generators.clean.cpp"/>
    <target name="generators.install" depends="generators.install.cpp"/>
    <target name="generators.dist" depends="generators.dist.cpp"/>
    
    <macrodef name="generator.cpp">
        <attribute name="input"/>
        <attribute name="output"/>
        <sequential>
            <java jar="${root.dir}/${bin.dir}/soft.generator.cpp/soft.generator.cpp-1.0.0.jar"
                  fork="true"
                  failonerror="true"
                  maxmemory="128m">
                  <arg value="-m"/>
                  <arg value="@{input}"/>
                  <arg value="-o"/>
                  <arg value="@{output}"/>
            </java>
        </sequential>
    </macrodef>
    
    <target name="sources.generate.ecore">
        <generator.cpp input="${root.dir}/${models.dir}/ecore.ecore" output="${root.dir}"/>
    </target>
    
    <target name="sources.clean.ecore">
        <exec executable="git" dir="${root.dir}/${libraries.dir}/ecore" failonerror="true">
            <arg line="clean -xfd" />
        </exec>
        <exec executable="git" dir="${root.dir}/${tests.dir}/ecore.tests" failonerror="true">
            <arg line="clean -xfd" />
        </exec>
    </target>
    
    <target name = "sources.generate" depends="sources.generate.ecore"/>
    <target name = "sources.clean" depends="sources.clean.ecore"/> 
    
    <target name="build.generate">
        <exec taskname="cmake" executable="cmake.exe" dir="${root.dir}/${build.dir}/cmake" failonerror="true">
            <arg value="-G"/>
            <arg value="Visual Studio 14 2015 Win64"/>
            <arg value="-B../vs2015"/>
            <arg value="-H."/>
        </exec>
    </target>
    
    <target name="build.clean">
        <exec executable="git" dir="${root.dir}/${build.dir}" failonerror="true">
            <arg line="clean -xfd" />
        </exec>
    </target>
    
    <target name="generators" depends="generators.build,generators.dist,generators.install"/>
    
    <target name="generates" depends="sources.generate,build.generate"/>
    
    <target name="clean" depends="generators.clean,sources.clean,build.clean"/>
    
    <target name="all" depends="generators,generates"/>
    
</project>